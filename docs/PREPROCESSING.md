# 전처리 및 ML 파이프라인 상세 문서

인플레이션 환경 디저트 소비 분석 프로젝트의 전처리 단계와 ML 파이프라인을 정리한 문서입니다.

---

## 1. 프로젝트 개요

| 항목 | 내용 |
|------|------|
| **데이터** | 서울시 상권분석 서비스 (추정매출-행정동) 5개년 (2020~2024) |
| **분석 대상** | 카페·제과점 (디저트) |
| **단위** | 행정동 × 연도 × 분기 |
| **목표** | 인플레이션 환경에서 디저트 소비 선호도 변화 분석 및 ML 예측 |

---

## 2. 데이터 소스 및 구조

### 2.1 원본 데이터

- **경로**: `data/raw/`
- **파일**: `서울시_상권분석서비스(추정매출-행정동)_YYYY년.csv`
- **인코딩**: CP949
- **분기 코드**: `기준_년분기_코드` (예: 20211 = 2021년 1분기)

### 2.2 주요 컬럼 (원본)

| 컬럼 | 설명 |
|------|------|
| 기준_년분기_코드 | YYYYQ 형식 |
| 행정동_코드 | 행정동 식별자 |
| 행정동_코드_명 | 행정동 이름 |
| 서비스_업종_코드_명 | 업종 (제과점, 커피-음료 등) |
| 당월_매출_금액 | 당월 매출 |
| 당월_매출_건수 | 당월 거래 건수 |
| 주중/주말_매출_금액 | 요일별 매출 |
| 남성/여성_매출_금액 | 성별 매출 |

---

## 3. 1단계: 데이터 로딩 및 필터링

### 3.1 디저트 업종 필터링 (`load_dessert.py`)

- **대상 업종**: `제과점`, `커피-음료` (서울시 상권 데이터 표준 분류)
- **함수**: `load_dessert_data()` → raw 로드 후 `filter_dessert()`
- **결과**: 15,922행 (5개년 전체 디저트 데이터)

### 3.2 연령대 컬럼 제거

- 12개 연령대 관련 컬럼 삭제 (분석 목적 외, 차원 축소)

---

## 4. 2단계: 집계 (년도·분기 × 행정동)

### 4.1 `aggregate_by_year_quarter_dong()`

- **집계 기준**: `연도`, `분기`, `행정동_코드`, `행정동_코드_명`
- **집계 방식**: `mean()` (카페·제과점 평균)
- **결과**: 8,366행, 420개 행정동

---

## 5. 3단계: ML 전처리 파이프라인 (`preprocess.py`)

### 5.1 비율화: 디저트 비중

```
디저트_비중 = (카페+제과점 매출 합계) / 전체 상권 매출
```

- **의미**: 선호도 지표, 행정동 규모 보정
- **범위**: 0 ~ 1 (clip 적용)

### 5.2 로그 변환

```
log_당월_매출_금액 = log(당월_매출_금액 + 1)
```

- **목적**: 분산 안정화, right-skew 완화
- **효과**: 선형회귀·트리 모델 안정성 향상

### 5.3 Lag 변수

| 변수 | 설명 |
|------|------|
| lag1 | 전분기 매출 |
| lag4 | 전년 동분기 매출 (계절성) |

- **생성**: 행정동별 시계열 정렬 후 `shift()`

### 5.4 성장률

```
성장률 = (이번분기 - 전분기) / 전분기
```

- **목적**: 트렌드 반영, 물가 상승률 비교
- **결측·무한대**: 0으로 대체

### 5.5 계절성 변수

- **분기→월**: 1→3, 2→6, 3→9, 4→12
- **인코딩**:
  - `month_sin = sin(2π × 월 / 12)`
  - `month_cos = cos(2π × 월 / 12)`

---

## 6. 4단계: 타겟 및 평가용 전처리

### 6.1 타겟 생성 (`add_target()`)

- **타겟**: 다음 분기 디저트 비중
- **생성**: `shift(-1)` (행정동별)
- **결측**: 마지막 분기 행

### 6.2 이상치 클리핑 (`clip_outliers()`)

- **방법**: IQR (Q1 - 1.5×IQR, Q3 + 1.5×IQR)
- **대상**: `성장률`, `디저트_비중`

### 6.3 다중공선성 (VIF)

- **함수**: `calculate_vif()`
- **기준**: VIF > 10 → 제거 또는 PCA 고려
- **현재 결과**:
  - lag1: VIF ≈ 30
  - lag4: VIF ≈ 30
  - 기타: VIF < 5

### 6.4 시계열 Train/Test 분리 (`time_split()`)

- **Train**: 연도 < 2024
- **Test**: 연도 ≥ 2024
- **Train 약 6,686행 / Test 약 1,680행**

### 6.5 군집용 피처 (`create_cluster_features()`)

- **단위**: 행정동
- **변수**: 매출 mean/std, 성장률 mean, 디저트_비중 mean
- **용도**: k-means, DBSCAN 등 군집 분석

---

## 7. ML 피처 및 모델

### 7.1 타겟 유출 방지 ⚠️

- **타겟**: 다음 분기 디저트 비중
- **주의**: 현재 분기 `디저트_비중`은 피처로 사용하지 않음 (거의 그대로 복사되는 데이터 유출)
- **대신**: `lag1_비중`, `lag4_비중` (과거 비중만 사용)

### 7.2 사용 피처

| 피처 | 설명 |
|------|------|
| log_당월_매출_금액 | 로그 변환 매출 |
| lag1, lag4 | 전분기·전년 동분기 매출 |
| lag1_비중, lag4_비중 | 전분기·전년 동분기 디저트 비중 |
| 성장률 | 전분기 대비 성장률 |
| month_sin, month_cos | 계절성 |
| 물가상승률 | CPI (data/cpi.csv 또는 예시값) |
| 물가_x_lag1비중 | 상호작용항 |

### 7.3 모델 (5개 비교)

| 모델 | 용도 |
|------|------|
| Linear Regression | 해석, 선형 관계 |
| Decision Tree | 불순도(MSE), 해석 |
| Random Forest | Bagging |
| XGBoost | Boosting (libomp 필요) |
| MLP | Shallow NN, 스케일링 필수 |

### 7.4 Feature Importance (RF)

- **lag1_비중**: ~82% (전분기 비중이 다음 분기 예측에 가장 중요)
- **lag4_비중**: ~13%
- 나머지: 각각 5% 미만

---

## 8. 시각화 결과물 (`outputs/`)

### 8.1 기본 시각화

| 파일 | 내용 |
|------|------|
| monthly_trend.png | 월별(분기별) 매출 추이 (5개년) |
| top_districts.png | 매출 상위 15개 행정동 |
| gender_ratio.png | 연도별 남·여 매출 비교 |

### 8.2 전처리 결과 시각화

| 파일 | 내용 |
|------|------|
| preprocess_dessert_ratio.png | 디저트 비중 분포 |
| preprocess_log_transform.png | 원본 vs 로그 변환 분포 |
| preprocess_lag1_scatter.png | lag1 vs 당월 매출 산점도 |
| preprocess_growth_rate.png | 성장률 분포 |
| preprocess_seasonality.png | 분기별 month_sin/cos |
| preprocess_correlation.png | 파생 변수 상관행렬 |

### 8.3 ML 및 군집 결과물

| 파일 | 내용 |
|------|------|
| feature_importance.csv | 피처 중요도 (RF, XGB, DT) |
| vif_results.csv | VIF 결과 |
| kmeans_cluster_trend.png | 군집별 디저트 비중 추이 |

---

## 9. 실행 스크립트

| 스크립트 | 역할 |
|----------|------|
| `scripts/preview_dessert.py` | 전처리 데이터 미리보기 및 CSV 저장 |
| `scripts/run_preprocess.py` | ML 전처리 실행 → `dessert_ml_ready.csv` |
| `scripts/run_visualize.py` | 기본 시각화 생성 |
| `scripts/run_preprocess_viz.py` | 전처리 결과 시각화 |
| `scripts/run_ml_pipeline.py` | 전체 ML 파이프라인 (VIF, 학습, 평가) |

---

## 10. 데이터 흐름 요약

```
raw CSV (5개년)
    → load_dessert_data() [필터: 제과점, 커피-음료]
    → aggregate_by_year_quarter_dong() [연도·분기·행정동 평균, 연령 제거]
    → preprocess_ml() [비중, 로그, lag, lag_비중, 성장률, 계절성]
    → add_target() [다음 분기 디저트 비중]
    → add_cpi() [물가상승률, 물가_x_lag1비중]
    → clip_outliers() [IQR]
    → time_split() [Train/Test]
    → train_and_evaluate() [LR, DT, RF, XGB, MLP]
    → plot_kmeans_clusters() [군집별 추이]
```

---

## 11. 권장 전처리 순서

1. 비율화 → 2. 로그 변환 → 3. Lag 생성 → 4. lag_비중 생성 → 5. 계절 변수
6. 타겟 생성 → 7. CPI 병합 → 8. 이상치 처리 → 9. VIF 확인 → 10. 시계열 분리

---

## 12. 교수님 질문 대비

| Q | A |
|---|---|
| 왜 디저트 비중이 이렇게 중요하게 나왔나요? | 현재 비중은 **피처에서 제외**했습니다. lag1_비중(전분기)이 중요하게 나온 이유는 디저트 비중이 시계열적으로 **높은 자기상관**을 갖기 때문입니다. |
| lag1, lag4 VIF 30이면 문제 아닌가요? | 다중공선성이 존재합니다. PCA 또는 변수 제거로 비교 실험을 수행할 수 있습니다. |
| 왜 RF가 잘 나왔나요? | 비선형 관계 및 변수 간 상호작용을 잘 포착하기 때문입니다. |
| 패널 데이터인가요? | 네, 행정동×분기 단위의 패널 데이터입니다. 행정동 고정효과(dummy) 또는 target encoding 적용 가능합니다. |
